openapi: 3.0.3
info:
  title: CtxOS API
  description: Context-driven OS Intelligence and Analysis API
  version: 1.0.0
  contact:
    name: CtxOS Team
    email: api@ctxos.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.ctxos.com
    description: Production server

tags:
  - name: auth
    description: Authentication and authorization
  - name: scoring
    description: Entity scoring and risk assessment
  - name: agents
    description: AI agent analysis and pipelines
  - name: config
    description: Configuration management

paths:
  /api/v1/auth/login:
    post:
      tags: [auth]
      summary: Authenticate user
      description: Authenticate user and return access and refresh tokens
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/refresh:
    post:
      tags: [auth]
      summary: Refresh access token
      description: Use refresh token to get new access token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshResponse'
        '401':
          description: Invalid or expired refresh token

  /api/v1/auth/me:
    get:
      tags: [auth]
      summary: Get current user info
      description: Get information about the currently authenticated user
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
        '401':
          description: Unauthorized

  /api/v1/auth/logout:
    post:
      tags: [auth]
      summary: Logout user
      description: Logout and revoke the current token
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'

  /api/v1/auth/verify:
    get:
      tags: [auth]
      summary: Verify token
      description: Verify if token is valid and return token info
      operationId: verifyToken
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenVerification'

  /api/v1/auth/health:
    get:
      tags: [auth]
      summary: Auth service health
      description: Get authentication service health status
      operationId: authHealth
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /api/v1/score:
    post:
      tags: [scoring]
      summary: Score entity
      description: Score an entity using specified scoring engines
      operationId: scoreEntity
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScoreRequest'
      responses:
        '200':
          description: Entity scored successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ScoringResult'
        '401':
          description: Unauthorized
        '403':
          description: Insufficient permissions
        '422':
          description: Validation error

  /api/v1/score/batch:
    post:
      tags: [scoring]
      summary: Batch score entities
      description: Score multiple entities in parallel
      operationId: batchScore
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchScoreRequest'
      responses:
        '200':
          description: Batch scoring completed
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ScoringResult'
        '400':
          description: Too many entities in batch

  /api/v1/score/history/{entity_id}:
    post:
      tags: [scoring]
      summary: Get scoring history
      description: Get historical scoring data for an entity
      operationId: getScoringHistory
      security:
        - bearerAuth: []
      parameters:
        - name: entity_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HistoryRequest'
      responses:
        '200':
          description: Historical data retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedResponse'

  /api/v1/score/engines:
    get:
      tags: [scoring]
      summary: List scoring engines
      description: Get list of available scoring engines
      operationId: listScoringEngines
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Engines list retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnginesList'

  /api/v1/score/aggregate:
    post:
      tags: [scoring]
      summary: Get aggregate scores
      description: Get aggregate scoring statistics for multiple entities
      operationId: getAggregateScores
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AggregateRequest'
      responses:
        '200':
          description: Aggregate scores retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AggregateResponse'

  /api/v1/score/compare:
    post:
      tags: [scoring]
      summary: Compare entities
      description: Compare scores between multiple entities
      operationId: compareEntities
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompareRequest'
      responses:
        '200':
          description: Comparison completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompareResponse'

  /api/v1/score/status:
    get:
      tags: [scoring]
      summary: Scoring service health
      description: Get scoring service health status
      operationId: scoringHealth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /api/v1/agents/run:
    post:
      tags: [agents]
      summary: Run agent
      description: Run a single agent on context data
      operationId: runAgent
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentRunRequest'
      responses:
        '200':
          description: Agent execution completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResult'
        '404':
          description: Agent not found

  /api/v1/agents/pipeline:
    post:
      tags: [agents]
      summary: Run pipeline
      description: Run an agent pipeline
      operationId: runPipeline
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PipelineRunRequest'
      responses:
        '200':
          description: Pipeline execution completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PipelineResult'

  /api/v1/agents/bulk:
    post:
      tags: [agents]
      summary: Bulk analysis
      description: Run agents on multiple entities
      operationId: bulkAnalysis
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkAnalysisRequest'
      responses:
        '200':
          description: Bulk analysis completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkAnalysisResult'

  /api/v1/agents/list:
    get:
      tags: [agents]
      summary: List agents
      description: Get list of available agents
      operationId: listAgents
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Agents list retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentsList'

  /api/v1/agents/status/{agent_name}:
    get:
      tags: [agents]
      summary: Get agent status
      description: Get status of a specific agent
      operationId: getAgentStatus
      security:
        - bearerAuth: []
      parameters:
        - name: agent_name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Agent status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentStatus'
        '404':
          description: Agent not found

  /api/v1/agents/pipelines:
    get:
      tags: [agents]
      summary: List pipelines
      description: Get list of available pipelines
      operationId: listPipelines
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Pipelines list retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PipelinesList'

  /api/v1/agents/create-pipeline:
    post:
      tags: [agents]
      summary: Create pipeline
      description: Create a new agent pipeline
      operationId: createPipeline
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePipelineRequest'
      responses:
        '200':
          description: Pipeline created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePipelineResponse'
        '409':
          description: Pipeline already exists

  /api/v1/agents/metrics:
    get:
      tags: [agents]
      summary: Get agent metrics
      description: Get performance metrics for agents
      operationId: getAgentMetrics
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Metrics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentMetrics'

  /api/v1/agents/health:
    get:
      tags: [agents]
      summary: Agent service health
      description: Get agent service health status
      operationId: agentHealth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /api/v1/agents/audit-logs:
    get:
      tags: [agents]
      summary: Get audit logs
      description: Get agent operation audit logs
      operationId: getAgentAuditLogs
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Audit logs retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedResponse'

  /api/v1/config:
    get:
      tags: [config]
      summary: Get configuration
      description: Get all configuration values
      operationId: getConfig
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Configuration retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'

  /api/v1/config/{config_key}:
    get:
      tags: [config]
      summary: Get configuration value
      description: Get a specific configuration value
      operationId: getConfigValue
      security:
        - bearerAuth: []
      parameters:
        - name: config_key
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Configuration value retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigValueResponse'
        '404':
          description: Configuration key not found

  /api/v1/config/update:
    post:
      tags: [config]
      summary: Update configuration
      description: Update a configuration value
      operationId: updateConfig
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigUpdateRequest'
      responses:
        '200':
          description: Configuration updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigUpdateResponse'
        '404':
          description: Configuration key not found

  /api/v1/config/rules:
    get:
      tags: [config]
      summary: Get rules
      description: Get all scoring rules
      operationId: getRules
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Rules retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RulesResponse'

    post:
      tags: [config]
      summary: Create rule
      description: Create a new scoring rule
      operationId: createRule
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleCreateRequest'
      responses:
        '200':
          description: Rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleCreateResponse'

  /api/v1/config/rules/{rule_id}:
    get:
      tags: [config]
      summary: Get rule
      description: Get a specific scoring rule
      operationId: getRule
      security:
        - bearerAuth: []
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Rule retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleResponse'
        '404':
          description: Rule not found

    put:
      tags: [config]
      summary: Update rule
      description: Update an existing scoring rule
      operationId: updateRule
      security:
        - bearerAuth: []
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleUpdateRequest'
      responses:
        '200':
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleUpdateResponse'

    delete:
      tags: [config]
      summary: Delete rule
      description: Delete a scoring rule
      operationId: deleteRule
      security:
        - bearerAuth: []
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Rule deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleDeleteResponse'

  /api/v1/config/export:
    post:
      tags: [config]
      summary: Export configuration
      description: Export configuration and rules
      operationId: exportConfig
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportRequest'
      responses:
        '200':
          description: Configuration exported
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportResponse'

  /api/v1/config/import:
    post:
      tags: [config]
      summary: Import configuration
      description: Import configuration and rules
      operationId: importConfig
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImportRequest'
      responses:
        '200':
          description: Configuration imported
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportResponse'

  /api/v1/config/health:
    get:
      tags: [config]
      summary: Config service health
      description: Get configuration service health status
      operationId: configHealth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Authentication Schemas
    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          description: User username
        password:
          type: string
          description: User password

    LoginResponse:
      type: object
      required: [access_token, refresh_token, token_type, expires_in, user_info]
      properties:
        access_token:
          type: string
          description: JWT access token
        refresh_token:
          type: string
          description: JWT refresh token
        token_type:
          type: string
          enum: [bearer]
          description: Token type
        expires_in:
          type: integer
          description: Token expiration time in seconds
        user_info:
          $ref: '#/components/schemas/UserInfo'

    RefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string
          description: Refresh token

    RefreshResponse:
      type: object
      required: [access_token, token_type, expires_in]
      properties:
        access_token:
          type: string
          description: New access token
        token_type:
          type: string
          enum: [bearer]
        expires_in:
          type: integer
          description: Token expiration time in seconds

    UserInfo:
      type: object
      required: [user_id, username, role, permissions]
      properties:
        user_id:
          type: string
          description: User ID
        username:
          type: string
          description: Username
        email:
          type: string
          description: User email
        role:
          type: string
          enum: [admin, analyst, viewer, api_client]
          description: User role
        permissions:
          type: array
          items:
            type: string
          description: User permissions
        is_active:
          type: boolean
          description: Whether user is active
        created_at:
          type: string
          format: date-time
          description: Account creation time
        last_login:
          type: string
          format: date-time
          description: Last login time

    TokenVerification:
      type: object
      required: [valid, token_info, expires_in]
      properties:
        valid:
          type: boolean
          description: Whether token is valid
        token_info:
          type: object
          description: Token information
        expires_in:
          type: integer
          description: Time until token expires in seconds

    # Common Schemas
    StatusResponse:
      type: object
      required: [status, message]
      properties:
        status:
          type: string
          enum: [success, error]
          description: Operation status
        message:
          type: string
          description: Status message
        details:
          type: object
          description: Additional details

    ErrorResponse:
      type: object
      required: [error, status_code]
      properties:
        error:
          type: string
          description: Error description
        status_code:
          type: integer
          description: HTTP status code
        timestamp:
          type: string
          format: date-time
          description: Error timestamp

    HealthStatus:
      type: object
      required: [service, status, timestamp]
      properties:
        service:
          type: string
          description: Service name
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Service health status
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp
        features:
          type: object
          description: Service features
        statistics:
          type: object
          description: Service statistics

    PaginatedResponse:
      type: object
      required: [items, total, limit, offset, has_next]
      properties:
        items:
          type: array
          items:
            type: object
          description: Response items
        total:
          type: integer
          description: Total number of items
        limit:
          type: integer
          description: Items per page
        offset:
          type: integer
          description: Number of items skipped
        has_next:
          type: boolean
          description: Whether there are more items

    # Data Model Schemas
    EntityType:
      type: string
      enum: [host, domain, ip, user, service, application, network, database]

    SignalType:
      type: string
      enum: [vulnerability, port, service, dns, ssl_certificate, configuration, activity, authentication, dependency, subdomain, whois]

    SeverityLevel:
      type: string
      enum: [critical, high, medium, low, info]

    Context:
      type: object
      required: [entity, signals]
      properties:
        entity:
          $ref: '#/components/schemas/Entity'
        signals:
          type: array
          items:
            $ref: '#/components/schemas/Signal'

    Entity:
      type: object
      required: [id, entity_type, name]
      properties:
        id:
          type: string
          description: Entity ID
        entity_type:
          $ref: '#/components/schemas/EntityType'
          description: Entity type
        name:
          type: string
          description: Entity name
        description:
          type: string
          description: Entity description
        properties:
          type: object
          description: Entity properties

    Signal:
      type: object
      required: [id, source, signal_type, severity, description]
      properties:
        id:
          type: string
          description: Signal ID
        source:
          type: string
          description: Signal source
        signal_type:
          $ref: '#/components/schemas/SignalType'
          description: Signal type
        severity:
          $ref: '#/components/schemas/SeverityLevel'
          description: Signal severity
        description:
          type: string
          description: Signal description
        timestamp:
          type: string
          format: date-time
          description: Signal timestamp
        entity_id:
          type: string
          description: Associated entity ID
        properties:
          type: object
          description: Signal properties

    # Scoring Schemas
    ScoreRequest:
      type: object
      required: [context, engines]
      properties:
        context:
          $ref: '#/components/schemas/Context'
          description: Entity context
        engines:
          type: array
          items:
            type: string
          description: Scoring engines to use
        include_recommendations:
          type: boolean
          default: true
          description: Include recommendations

    BatchScoreRequest:
      type: object
      required: [contexts, engines]
      properties:
        contexts:
          type: array
          items:
            $ref: '#/components/schemas/Context'
          description: Entity contexts
        engines:
          type: array
          items:
            type: string
          description: Scoring engines to use
        parallel:
          type: boolean
          default: true
          description: Process in parallel

    ScoringResult:
      type: object
      required: [entity_id, entity_type, engine_name, score, severity, timestamp]
      properties:
        entity_id:
          type: string
          description: Entity ID
        entity_type:
          $ref: '#/components/schemas/EntityType'
          description: Entity type
        engine_name:
          type: string
          description: Scoring engine name
        score:
          type: number
          format: float
          description: Risk score (0-100)
        severity:
          $ref: '#/components/schemas/SeverityLevel'
          description: Risk severity
        factors:
          type: object
          description: Score factors
        recommendations:
          type: array
          items:
            type: string
          description: Recommendations
        timestamp:
          type: string
          format: date-time
          description: Scoring timestamp

    HistoryRequest:
      type: object
      required: [date_from, date_to]
      properties:
        date_from:
          type: string
          format: date-time
          description: Start date
        date_to:
          type: string
          format: date-time
          description: End date
        engines:
          type: array
          items:
            type: string
          description: Engines to include
        granularity:
          type: string
          enum: [hourly, daily, weekly, monthly]
          description: Data granularity
        limit:
          type: integer
          description: Maximum results

    EnginesList:
      type: object
      required: [engines, total, available]
      properties:
        engines:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/EngineInfo'
          description: Engine information
        total:
          type: integer
          description: Total engines
        available:
          type: integer
          description: Available engines

    EngineInfo:
      type: object
      required: [name, status, description]
      properties:
        name:
          type: string
          description: Engine name
        status:
          type: string
          enum: [available, unavailable, degraded]
          description: Engine status
        description:
          type: string
          description: Engine description
        version:
          type: string
          description: Engine version

    # Agent Schemas
    AgentRunRequest:
      type: object
      required: [agent_name, context]
      properties:
        agent_name:
          type: string
          description: Agent name
        context:
          $ref: '#/components/schemas/Context'
          description: Entity context
        scoring_result:
          type: object
          description: Scoring result context
        timeout_seconds:
          type: number
          format: float
          default: 30.0
          description: Execution timeout

    AgentResult:
      type: object
      required: [agent_name, success, duration_ms, timestamp]
      properties:
        agent_name:
          type: string
          description: Agent name
        success:
          type: boolean
          description: Execution success
        output:
          type: object
          description: Agent output
        error:
          type: string
          description: Error message
        duration_ms:
          type: number
          description: Execution duration in milliseconds
        timestamp:
          type: string
          format: date-time
          description: Execution timestamp

    PipelineRunRequest:
      type: object
      oneOf:
        - required: [pipeline_name, context]
        - required: [agents, context]
      properties:
        pipeline_name:
          type: string
          description: Pipeline name
        agents:
          type: array
          items:
            type: string
          description: Agent names for custom pipeline
        context:
          $ref: '#/components/schemas/Context'
          description: Entity context
        scoring_result:
          type: object
          description: Scoring result context
        parallel:
          type: boolean
          description: Run agents in parallel
        timeout_seconds:
          type: number
          format: float
          default: 60.0
          description: Pipeline timeout

    PipelineResult:
      type: object
      required: [pipeline_name, results, success_count, total_count, duration_ms, timestamp]
      properties:
        pipeline_name:
          type: string
          description: Pipeline name
        results:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/AgentResult'
          description: Agent results
        success_count:
          type: integer
          description: Number of successful agents
        total_count:
          type: integer
          description: Total number of agents
        duration_ms:
          type: number
          description: Pipeline duration in milliseconds
        timestamp:
          type: string
          format: date-time
          description: Execution timestamp

    # Configuration Schemas
    ConfigUpdateRequest:
      type: object
      required: [config_key, value]
      properties:
        config_key:
          type: string
          description: Configuration key
        value:
          description: Configuration value
        description:
          type: string
          description: Update description

    ConfigResponse:
      type: object
      required: [config, metadata]
      properties:
        config:
          type: object
          description: Configuration values
        metadata:
          type: object
          description: Configuration metadata

    RuleCreateRequest:
      type: object
      required: [rule_id, rule_type, name, condition, action]
      properties:
        rule_id:
          type: string
          description: Rule ID
        rule_type:
          type: string
          enum: [risk, exposure, drift]
          description: Rule type
        name:
          type: string
          description: Rule name
        description:
          type: string
          description: Rule description
        condition:
          type: object
          description: Rule condition
        action:
          type: object
          description: Rule action
        priority:
          type: integer
          default: 100
          description: Rule priority
        enabled:
          type: boolean
          default: true
          description: Whether rule is enabled
